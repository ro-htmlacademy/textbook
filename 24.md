# Дифференцированный подход к отображению ошибок

Это не исправление, а дополнение к учебнику.

> **Внимание!** Хотя данный раздел формально относится к работе с ошибками, рассматриваемой в главе 2.4, но реализацию приведенных ниже рекомендаций следует отложить до финальных этапов работы над проектом. Однако теорию можно и нужно посмотреть уже сейчас.

Одним из важных отличий профессионального кода от учебного является дифференцированный подход к отображению ошибок.

Авторы учебного кода практически никогда не задумываюся о том, что их сайт по идее когда-нибудь "встанет на боевое дежурство", и при этом его аудитория кардинальным образом поменяется: сам программист уже не будет сидеть и видеть результат работы каждого скрипта. В то же время у сайта появятся пользователи, у которых совершенно другие интересы. 

И интересы эти подчас диаметрально противоположные. Судите сами: Программисту надо видеть каждую ошибку, которая происходит на сайте, причём в мельчайших подробностях. В то время как пользователям ошибки показывать ни в коем случае нельзя! Программисту необходим подробный текст ошибки, а пользователю наоборот - уклончивое сообщение о том что на сайте временные проблемы, но главное - остаться в привычном интерфейсе, чтобы было куда нажать.

Но что самое удивительное - это что такие различные интересы очень легко удовлетворить! Для этого надо следовать простым правилам:

- код проекта всегда только *порождает* ошибки, но никогда сам не занимается их обработкой (и тем паче - выводом их на экран)
- режим работы сайта четко делится на режим разработки и боевой режим 
 - в режиме разработки все ошибки показываются как есть
 - в боевом режиме ошибки никогда не показываются на экране, а пишутся в **лог ошибок**. При этом пользователю показывается специальная страница ошибки, подобная тем, что будут добавлены впоследствии к коду учебного сайта, но только для кода 500.

> (*глядя на эти простые правила становится понятно, почему меня так вымораживает подход к отображению ошибок базы данных, принятый в основном учебнике: все ошибки тупо выводятся сразу на экран, без возможности как-то изменить такое поведение. Это один из наиболее характерных признаков ученического подхода. О том, как можно будет привести ошибки БД к общему знаменателю, будет показано в исправленной главе 5.1*)

Разделение режимов можно сделать по-разному, но одним из самых простых способов будет использование конфигурационной опции РНР `display_errors`. В зависимости от её значения РНР будет либо показывать ошибки на экране, либо не будет. 

Также в боевом режиме надо использовать опцию `log_errors`, которая автоматически будет писать все ошибки в лог.

И дальше там только останется определить - не в боевом ли режиме запустился сайт - и если да, то написать два простых обработчика: ошибок и исключений.

Вообще, обработчики могут быть очень развесистыми. Но для нашего случай подойдут совсем простые, буквально в пару строк.

Само разделение режимов обычно делается внутри обработчика, но в простейшем случае можно сделать условие, которое будет проверять значение `display_errors`, 

То есть самый простой вариант пользовательского обработчика исключений будет таким

```php
if (ini_get('display_errors')) {
    set_exception_handler(function ($e)
    {
        error_page(500);
    }
});
```
где error_page() - это функция, которая отображает страницу сайта с текстом ошибки.

Подробнее можно почитать на странице документации по функции [set_exception_handler()](https://www.php.net/manual/ru/function.set-exception-handler.php).    
Вкратце, эта функция принимает в качестве аргумента либо имя функции, либо сам код функции, которая будет вызываться в случае, если код выбрасывает исключение, которое не было поймано. То есть всё очень просто: произошла ошибка в коде, которая привела к выбросу исключения (например, ошибка SQL запроса)? Вызывается код, который описан выше. 

Теперь останется добавить подобным обрадом пользовательский обработчик *ошибок*, который будет либо так же вызывать error_page(), либо конвертировать все ошибки в исключения, выбрасывая внутри себя исключение с текстом ошибки.
